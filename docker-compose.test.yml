# Docker Compose for Frontend Tests
#
# Usage (without backend - mocked tests):
#   .\scripts\test.ps1 docker e2e:mocked
#   ./scripts/test.sh docker e2e:mocked
#
# Usage (with backend - full E2E):
#   .\scripts\test.ps1 docker-full e2e
#   ./scripts/test.sh docker-full e2e
#
# Or directly:
#   docker compose -f docker-compose.test.yml run --rm test test:e2e:mocked
#   docker compose -f docker-compose.test.yml run --rm test-with-backend test:e2e:all

# Use separate project name to avoid conflicts with main lazyaf stack
name: lazyaf-tests

services:
  # Headless test runner (no backend - for mocked tests)
  test:
    build:
      context: .
      dockerfile: tdd/frontend/Dockerfile
    volumes:
      # Mount source for live updates (optional, remove for CI)
      - ./tdd/frontend/e2e:/app/tdd/frontend/e2e:ro
      - ./tdd/frontend/fixtures:/app/tdd/frontend/fixtures:ro
      - ./frontend/src:/app/frontend/src:ro
      # Mount results directory to get reports
      - ./tdd/frontend/e2e-results:/app/tdd/frontend/e2e-results
      - ./tdd/frontend/e2e-report:/app/tdd/frontend/e2e-report
    environment:
      - CI=true
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    working_dir: /app/tdd/frontend
    entrypoint: ["pnpm"]
    command: ["test:e2e:mocked"]

  # Headless test runner WITH backend
  test-with-backend:
    build:
      context: .
      dockerfile: tdd/frontend/Dockerfile
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./tdd/frontend/e2e:/app/tdd/frontend/e2e:ro
      - ./tdd/frontend/fixtures:/app/tdd/frontend/fixtures:ro
      - ./frontend/src:/app/frontend/src:ro
      - ./tdd/frontend/e2e-results:/app/tdd/frontend/e2e-results
      - ./tdd/frontend/e2e-report:/app/tdd/frontend/e2e-report
    environment:
      - CI=true
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - VITE_BACKEND_URL=http://backend:8000
      - BACKEND_URL=http://backend:8000
    working_dir: /app/tdd/frontend
    entrypoint: ["pnpm"]
    command: ["test:e2e:all"]

  # Interactive UI mode (requires X11 forwarding or VNC)
  test-ui:
    build:
      context: .
      dockerfile: tdd/frontend/Dockerfile
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./tdd/frontend:/app/tdd/frontend
      - ./frontend/src:/app/frontend/src:ro
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - VITE_BACKEND_URL=http://backend:8000
      - BACKEND_URL=http://backend:8000
    ports:
      - "9323:9323"  # Playwright UI port
    working_dir: /app/tdd/frontend
    entrypoint: ["pnpm"]
    command: ["test:e2e:ui", "--host", "0.0.0.0"]
    # For Linux with X11:
    # volumes:
    #   - /tmp/.X11-unix:/tmp/.X11-unix

  # Backend service for tests
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - LAZYAF_TEST_MODE=true
      - LAZYAF_MOCK_AI=true
    expose:
      - "8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
