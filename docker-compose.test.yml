# Docker Compose for Frontend Tests
#
# Usage:
#   docker compose -f docker-compose.test.yml run --rm test pnpm test:e2e:stories
#   docker compose -f docker-compose.test.yml run --rm test pnpm test:e2e:p0
#   docker compose -f docker-compose.test.yml up test-ui  # For Playwright UI (needs X11/display)
#
# Quick commands via scripts:
#   .\scripts\test.ps1 docker e2e:stories
#   ./scripts/test.sh docker e2e:stories

# Use separate project name to avoid conflicts with main lazyaf stack
name: lazyaf-tests

services:
  # Headless test runner
  test:
    build:
      context: .
      dockerfile: tdd/frontend/Dockerfile
    volumes:
      # Mount source for live updates (optional, remove for CI)
      - ./tdd/frontend/e2e:/app/tdd/frontend/e2e:ro
      - ./tdd/frontend/fixtures:/app/tdd/frontend/fixtures:ro
      - ./frontend/src:/app/frontend/src:ro
      # Mount results directory to get reports
      - ./tdd/frontend/e2e-results:/app/tdd/frontend/e2e-results
      - ./tdd/frontend/e2e-report:/app/tdd/frontend/e2e-report
    environment:
      - CI=true
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    working_dir: /app/tdd/frontend
    # Default: run story tests (work with mocked backend)
    entrypoint: ["pnpm"]
    command: ["test:e2e:stories"]

  # Interactive UI mode (requires X11 forwarding or VNC)
  test-ui:
    build:
      context: .
      dockerfile: tdd/frontend/Dockerfile
    volumes:
      - ./tdd/frontend:/app/tdd/frontend
      - ./frontend/src:/app/frontend/src:ro
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    ports:
      - "9323:9323"  # Playwright UI port
    working_dir: /app/tdd/frontend
    entrypoint: ["pnpm"]
    command: ["test:e2e:ui", "--host", "0.0.0.0"]
    # For Linux with X11:
    # volumes:
    #   - /tmp/.X11-unix:/tmp/.X11-unix

  # Run with backend for real tier tests
  test-real:
    build:
      context: .
      dockerfile: tdd/frontend/Dockerfile
    depends_on:
      - backend
    volumes:
      - ./tdd/frontend/e2e-results:/app/tdd/frontend/e2e-results
      - ./tdd/frontend/e2e-report:/app/tdd/frontend/e2e-report
    environment:
      - CI=true
      - BACKEND_URL=http://backend:8000
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    working_dir: /app/tdd/frontend
    entrypoint: ["pnpm"]
    command: ["test:e2e:real"]

  # Backend service for real tier tests
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - LAZYAF_TEST_MODE=true
      - LAZYAF_MOCK_AI=true
    expose:
      - "8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 5s
      timeout: 5s
      retries: 5
