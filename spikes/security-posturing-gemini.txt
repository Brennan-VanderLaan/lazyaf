# Spike: Security Posture Analysis

This document outlines the current security posture of the LazyAF application, identifies key risks, and proposes actionable items to improve it. This analysis is based on a review of the backend and frontend codebase.

## 1. Current State & Biggest Concerns (How bad is it?)

The current security posture is **critically weak**. The application appears to be in an early development stage, with security features being largely absent. It is **not safe for production use or exposure to the public internet** in its current form.

The single most critical vulnerability is the **complete lack of authentication and authorization**.

### Key Vulnerabilities:

*   **No Authentication:** There is no concept of a user, login, or API key. All API endpoints are unprotected. Anyone with network access to the backend can perform any action.
*   **No Authorization/Access Control:** Since there are no users, there is no way to control who can access or modify specific resources. Any user can create, read, update, and delete any repository, card, or pipeline.
*   **Unprotected Git Server:** The internal git server is exposed via HTTP and is unprotected. Anyone can clone, fetch, or (most critically) **push** code to any repository managed by the application, including modifying branches created by AI agents or merging code into the default branch.
*   **Potential for Arbitrary Code Execution:** The `shell` step type in pipelines allows running arbitrary shell commands on the backend server. Without an authentication layer, any user can define and trigger a pipeline that executes malicious code, compromising the host system. While runners are containerized, pipeline steps themselves may not be.
*   **Insecure WebSockets:** The WebSocket endpoint for real-time updates is unprotected. A malicious client could connect and potentially send malformed data, causing denial-of-service or other issues.
*   **Information Exposure:** API endpoints expose internal details, such as database IDs and full file paths in some git operations, which could be leveraged by an attacker.

## 2. What is Okay? (Positive Security Aspects)

Despite the critical issues, some good security practices are already in place:

*   **Use of Pydantic:** The backend uses Pydantic for API input validation, which prevents many common data-related vulnerabilities like injection attacks and malformed requests.
*   **Containerized Runners:** AI agents run in Docker containers. This is a crucial security boundary that helps isolate potentially untrusted code generated by AI models from the host system. The effectiveness of this depends on the Docker configuration (e.g., running as non-root, dropping capabilities).
*   **Safe Git Operations:** The use of the `dulwich` library instead of shelling out to `git` CLI commands helps prevent shell command injection vulnerabilities. Path traversal is also prevented by using system-generated UUIDs for repository paths.
*   **CORS Policy:** A restrictive CORS policy is in place, which is a good practice for preventing unwanted cross-origin browser attacks.

## 3. Actionable Items & Effort Estimation

Below is a prioritized list of actions to establish a reasonable security baseline. The effort is estimated in general terms (Low, Medium, High).

### High Priority (Critical)

1.  **Implement an Authentication Layer:**
    *   **Action:** Introduce a user model to the database. Implement an authentication mechanism. A simple bearer token (API key) system per user would be a good start. For a more robust system, consider OAuth2.
    *   **Effort:** High. This is a fundamental change that will touch almost every part of the application.
    *   **Details:**
        *   Create `User` model (`id`, `email`, `hashed_password`, `api_key`).
        *   Create API endpoints for user registration and login (`/auth/token`).
        *   Implement a FastAPI dependency (`Depends`) to require authentication for all sensitive endpoints.

2.  **Protect All API Endpoints:**
    *   **Action:** Apply the authentication dependency to all existing API routers. No endpoint (except perhaps `/health` and `/docs`) should be accessible without a valid token.
    *   **Effort:** Medium. Requires modifying every router and API call.

3.  **Secure the Internal Git Server:**
    *   **Action:** The git endpoints (`/git/*`) must be protected. Standard git clients support authentication over HTTP (e.g., using the API key as a password). The git router should validate credentials before processing any git command.
    *   **Effort:** Medium. Requires integrating the auth system with the `dulwich` backend.

### Medium Priority (Important)

4.  **Introduce an Authorization/Access Control Layer:**
    *   **Action:** Implement ownership and permissions. A user should only be able to access repositories they have created or been granted access to.
    *   **Effort:** High. Requires significant changes to database models and business logic.
    *   **Details:**
        *   Add a `user_id` foreign key to the `Repo` model.
        *   Update all database queries to filter by the current user.

5.  **Harden Runner and Pipeline Execution:**
    *   **Action:** Review the execution environment for pipelines, especially the `shell` step. If not already, these steps should be executed within a containerized, ephemeral, and resource-limited environment. Ensure Docker runners are properly sandboxed (e.g., run as a non-root user, have no unnecessary privileges, read-only filesystem where possible).
    *   **Effort:** Medium.

6.  **Add Input Sanitization for Shell Commands:**
    *   **Action:** For `shell` steps in pipelines, ensure that any user-provided input that is interpolated into the command is properly sanitized to prevent command injection.
    *   **Effort:** Low.

### Low Priority (Good Practices)

7.  **Secrets Management:**
    *   **Action:** For production, integrate a proper secrets management tool (like HashiCorp Vault or a cloud provider's service) for storing API keys and other secrets, rather than relying solely on environment variables.
    *   **Effort:** Low to Medium.

8.  **Dependency Scanning:**
    *   **Action:** Integrate a dependency scanning tool (like `pip-audit` for Python, `npm audit` for Node.js) into the CI/CD pipeline to automatically check for known vulnerabilities in third-party libraries.
    *   **Effort:** Low.

9.  **Rate Limiting:**
    *   **Action:** Implement rate limiting on the API, especially on authentication endpoints, to protect against brute-force attacks.
    *   **Effort:** Low.

## 4. Summary & Effort to Fix

The application currently lacks fundamental security controls, making it vulnerable to trivial takeover. The highest priority is to implement a comprehensive authentication and authorization system.

*   **Estimated Effort for Baseline Security:** A significant effort is required. Implementing just the critical items (AuthN, AuthZ, securing git) would likely take a developer several days to a week to implement correctly, including writing tests.
*   **Overall Recommendation:** Security should be the top priority before any further feature development if this application is intended to be used by more than a single, trusted user in an isolated environment.
